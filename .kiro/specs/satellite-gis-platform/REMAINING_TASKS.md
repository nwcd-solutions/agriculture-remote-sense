# 剩余任务列表

## 当前状态总结 (2026-02-06)

### ✅ 已完成的核心功能

#### Lambda API实现
- [x] Query Lambda - 卫星数据查询 (Sentinel-2, Sentinel-1, Landsat-8, MODIS)
- [x] Process Lambda - 任务管理和Batch集成
- [x] AOI Lambda - 几何验证和文件上传
- [x] Lambda Layer - 简化的boto3依赖
- [x] API Gateway - REST API + API Key认证
- [x] IAM权限配置 - 完整的权限策略

#### 基础设施
- [x] Network Stack - VPC和安全组
- [x] Storage Stack - S3存储桶
- [x] Database Stack - DynamoDB表
- [x] Batch Stack - AWS Batch计算环境
- [x] Lambda API Stack - Lambda函数和API Gateway
- [x] Frontend Stack - AWS Amplify托管
- [x] Monitoring Stack - CloudWatch仪表板

#### 前端功能
- [x] 地图显示 (Leaflet + OSM)
- [x] AOI绘制
- [x] 数据查询界面
- [x] 查询结果展示
- [x] 植被指数处理界面
- [x] 任务状态显示和刷新
- [x] 结果下载

#### 数据处理
- [x] STAC API查询集成
- [x] 植被指数计算 (NDVI, SAVI, EVI, VGI)
- [x] AWS Batch作业提交
- [x] 任务状态同步
- [x] S3结果存储

### 🔄 部分完成的功能

#### 错误处理和监控
- [x] Lambda函数错误处理
- [x] 前端错误提示
- [ ] CloudWatch告警配置
- [ ] 详细的监控仪表板
- [ ] 错误通知机制

#### 测试
- [x] 基本功能测试 (手动)
- [ ] 单元测试
- [ ] 属性测试 (PBT)
- [ ] 集成测试
- [ ] 性能测试

---

## 🎯 优先级1: 核心功能完善 (1-2周)

### 1. 任务状态同步优化
**当前问题**: 前端需要手动刷新任务状态

**任务**:
- [ ] 1.1 实现后台定时同步Batch状态到DynamoDB
  - 创建Lambda函数定期扫描运行中的任务
  - 查询Batch状态并更新DynamoDB
  - 使用EventBridge定时触发 (每分钟)
  - _需求: 10.4, 10.6_

- [ ] 1.2 实现WebSocket实时推送 (可选)
  - 使用API Gateway WebSocket
  - 推送任务状态更新到前端
  - 减少前端轮询频率
  - _需求: 10.5_

- [ ] 1.3 优化前端轮询策略
  - 实现智能轮询间隔 (任务运行时5秒，完成后停止)
  - 添加重连逻辑
  - 显示最后更新时间
  - _需求: 10.5_

### 2. Batch作业完成处理
**当前问题**: 任务完成后需要手动刷新才能看到结果

**任务**:
- [ ] 2.1 实现Batch作业完成事件处理
  - 配置EventBridge规则监听Batch作业状态变化
  - 创建Lambda函数处理作业完成事件
  - 自动更新DynamoDB任务状态
  - 生成S3预签名URL
  - _需求: 10.6, 10.8_

- [ ] 2.2 实现任务失败重试逻辑
  - 检查retry_count < max_retries
  - 自动重新提交失败的任务
  - 记录重试历史
  - _需求: 10.6_

### 3. 资源清理
**当前问题**: 过期数据未自动清理

**任务**:
- [ ] 3.1 验证DynamoDB TTL配置
  - 确认TTL属性正确设置
  - 测试30天后自动删除
  - _需求: 10.9_

- [ ] 3.2 实现S3生命周期策略
  - 配置30天后自动删除结果文件
  - 配置1天后删除临时文件
  - _需求: 10.3, 10.9_

- [ ] 3.3 实现CloudWatch日志清理
  - 设置日志保留期限 (30天)
  - 配置日志组自动删除
  - _需求: 10.7_

---

## 🎯 优先级2: 测试和质量保证 (2-3周)

### 4. 单元测试
**目标**: 为核心功能添加单元测试

**任务**:
- [ ] 4.1 Lambda函数单元测试
  - 测试Query Lambda的STAC查询逻辑
  - 测试Process Lambda的任务管理逻辑
  - 测试AOI Lambda的几何验证
  - 使用pytest和moto模拟AWS服务
  - _需求: 9.1_

- [ ] 4.2 前端组件单元测试
  - 测试MapComponent渲染和交互
  - 测试DataQueryPanel表单验证
  - 测试ProcessingConfigPanel状态管理
  - 使用Jest和React Testing Library
  - _需求: 8.3.5_

- [ ] 4.3 数据处理单元测试
  - 测试植被指数计算公式
  - 测试坐标转换逻辑
  - 测试GeoJSON解析
  - _需求: 5.2, 5.3, 5.4_

### 5. 属性测试 (PBT)
**目标**: 实现关键正确性属性的测试

**任务**:
- [ ] 5.1 数据查询属性测试
  - **属性1**: 卫星类型过滤一致性
  - **属性2**: 云量过滤有效性
  - **属性3**: 时间范围过滤正确性
  - 使用Hypothesis生成测试数据
  - _需求: 3.1, 3.3, 3.4_

- [ ] 5.2 植被指数计算属性测试
  - **属性12**: NDVI计算公式正确性
  - **属性13**: SAVI计算公式正确性
  - **属性14**: EVI计算公式正确性
  - 验证数学公式实现
  - _需求: 5.2, 5.3, 5.4_

- [ ] 5.3 AOI处理属性测试
  - **属性6**: AOI格式标准化
  - **属性7**: GeoJSON解析往返一致性
  - 测试几何转换的正确性
  - _需求: 2.3, 2.4_

### 6. 集成测试
**目标**: 端到端功能测试

**任务**:
- [ ] 6.1 完整查询流程测试
  - 用户绘制AOI → 查询数据 → 显示结果
  - 验证所有步骤正常工作
  - _需求: 3.1-3.8_

- [ ] 6.2 完整处理流程测试
  - 选择影像 → 提交处理 → 等待完成 → 下载结果
  - 验证Batch作业执行
  - 验证结果文件生成
  - _需求: 5.1-5.9_

- [ ] 6.3 错误场景测试
  - 测试无效输入处理
  - 测试网络错误恢复
  - 测试任务失败处理
  - _需求: 9.1_

---

## 🎯 优先级3: 监控和运维 (1-2周)

### 7. CloudWatch监控
**目标**: 完善监控和告警

**任务**:
- [ ] 7.1 配置CloudWatch告警
  - Lambda错误率告警 (> 5%)
  - API Gateway 5xx错误告警
  - Batch作业失败告警
  - DynamoDB读写容量告警
  - _需求: 10.7_

- [ ] 7.2 创建监控仪表板
  - Lambda调用次数和延迟
  - API请求数和响应时间
  - Batch作业队列长度
  - 任务成功/失败统计
  - _需求: 10.7_

- [ ] 7.3 配置SNS通知
  - 创建SNS主题
  - 配置邮件通知
  - 集成到CloudWatch告警
  - _需求: 10.8_

### 8. 日志和追踪
**目标**: 改进日志记录和问题排查

**任务**:
- [ ] 8.1 结构化日志
  - 统一日志格式 (JSON)
  - 添加请求ID追踪
  - 记录关键操作和性能指标
  - _需求: 10.7_

- [ ] 8.2 集成X-Ray追踪 (可选)
  - 启用Lambda X-Ray追踪
  - 追踪跨服务调用
  - 分析性能瓶颈
  - _未来扩展_

---

## 🎯 优先级4: 功能增强 (3-4周)

### 9. 多卫星支持完善
**当前状态**: 已支持Sentinel-2, Sentinel-1, Landsat-8, MODIS查询

**任务**:
- [ ] 9.1 完善前端卫星选择界面
  - 添加卫星类型选择器
  - 根据卫星类型动态显示产品级别
  - 更新云量过滤逻辑
  - _需求: 3.1, 3.2_

- [ ] 9.2 测试所有卫星类型
  - 测试Sentinel-1查询和处理
  - 测试Landsat-8查询和处理
  - 测试MODIS查询和处理
  - _需求: 1.1, 1.3, 1.4_

### 10. 时间合成功能
**当前状态**: 未实现

**任务**:
- [ ] 10.1 实现时间合成处理器
  - 创建TemporalCompositor类
  - 实现月度合成方法
  - 实现云掩膜应用
  - _需求: 7.1, 7.2, 7.3_

- [ ] 10.2 实现时间合成API
  - 创建POST /api/process/composite端点
  - 集成到Batch作业
  - 支持多个合成周期
  - _需求: 7.4, 7.5, 7.6_

- [ ] 10.3 实现前端时间合成界面
  - 添加合成模式选择
  - 添加合成周期选择
  - 显示合成任务进度
  - _需求: 7.7_

### 11. 中国地图服务集成
**当前状态**: 仅支持OSM

**任务**:
- [ ] 11.1 实现坐标系转换
  - 创建CoordinateTransformer类
  - 实现WGS84 ↔ GCJ02转换
  - 实现WGS84 ↔ BD09转换
  - _需求: 8.1.8_

- [ ] 11.2 集成高德地图
  - 申请高德地图API Key
  - 集成leaflet.chinatmsproviders
  - 实现地图服务切换
  - _需求: 8.1.2, 8.1.6_

- [ ] 11.3 集成天地图
  - 申请天地图API Key
  - 添加天地图图层
  - 实现自动服务选择
  - _需求: 8.1.3, 8.1.7_

### 12. Shapefile支持
**当前状态**: 仅支持GeoJSON

**任务**:
- [ ] 12.1 实现Shapefile解析
  - 安装fiona和shapely
  - 实现.zip文件上传
  - 解析Shapefile并转换为GeoJSON
  - _需求: 2.2_

- [ ] 12.2 更新前端上传界面
  - 使用react-dropzone
  - 支持拖拽上传
  - 显示文件解析进度
  - _需求: 2.2_

---

## 🎯 优先级5: 性能优化 (2-3周)

### 13. Lambda性能优化
**任务**:
- [ ] 13.1 配置预留并发
  - 为Process Lambda配置预留并发
  - 减少冷启动影响
  - 监控并发使用情况
  - _需求: 9.5_

- [ ] 13.2 优化Lambda内存配置
  - 使用Lambda Power Tuning工具
  - 找到最优内存配置
  - 平衡性能和成本
  - _需求: 9.5_

- [ ] 13.3 实现响应缓存
  - 缓存STAC查询结果 (5分钟)
  - 使用Lambda环境变量或ElastiCache
  - 减少重复查询
  - _需求: 9.5_

### 14. Batch性能优化
**任务**:
- [ ] 14.1 优化Batch实例类型
  - 测试不同实例类型的性能
  - 选择最优的CPU/内存配置
  - 调整Spot出价策略
  - _需求: 10.10_

- [ ] 14.2 优化数据处理流程
  - 使用Dask并行处理
  - 优化GDAL配置
  - 减少内存使用
  - _需求: 9.4, 9.5_

### 15. 前端性能优化
**任务**:
- [ ] 15.1 实现代码分割
  - 使用React.lazy和Suspense
  - 按路由分割代码
  - 减少初始加载时间
  - _需求: 9.5_

- [ ] 15.2 优化资源加载
  - 实现图片懒加载
  - 压缩和优化图片
  - 使用CDN加速
  - _需求: 9.5_

---

## 🎯 优先级6: 文档和部署 (1周)

### 16. 文档完善
**任务**:
- [ ] 16.1 更新README.md
  - 项目介绍和架构说明
  - 快速开始指南
  - 部署说明
  - _需求: 6.3_

- [ ] 16.2 创建API文档
  - 详细的API端点说明
  - 请求/响应示例
  - 错误代码说明
  - _需求: 6.3_

- [ ] 16.3 创建用户指南
  - 功能使用说明
  - 常见问题解答
  - 故障排查指南
  - _需求: 6.3_

- [ ] 16.4 创建运维文档
  - 部署流程
  - 监控和告警配置
  - 备份和恢复
  - _需求: 10.11_

### 17. 部署自动化
**任务**:
- [ ] 17.1 创建部署脚本
  - 一键部署所有stacks
  - 环境变量配置
  - 部署验证
  - _需求: 10.12_

- [ ] 17.2 实现多环境部署
  - dev, staging, prod环境配置
  - 环境隔离
  - 配置管理
  - _需求: 10.12_

---

## 🎯 可选增强功能 (未来迭代)

### 18. 高级功能
- [ ] 18.1 用户认证系统
  - 用户注册和登录
  - JWT认证
  - 权限管理
  - _未来扩展_

- [ ] 18.2 查询历史保存
  - 保存查询参数和AOI
  - 历史记录管理
  - 快速恢复查询
  - _未来扩展_

- [ ] 18.3 批量下载功能
  - 批量选择影像
  - 打包下载 (ZIP)
  - 下载进度跟踪
  - _需求: 4.2_

### 19. 源代码透明性
- [ ] 19.1 实现代码查看功能
  - 创建CodeViewerPanel组件
  - 集成Prism.js代码高亮
  - 显示植被指数公式
  - _需求: 6.1, 6.2_

- [ ] 19.2 创建算法文档
  - 植被指数计算说明
  - 时间合成算法说明
  - 坐标转换说明
  - _需求: 6.3_

### 20. UI/UX改进
- [ ] 20.1 实现现代简约UI
  - 统一配色方案
  - 响应式布局
  - 平滑过渡动画
  - _需求: 8.3.6_

- [ ] 20.2 改进错误提示
  - 统一错误提示组件
  - 友好的错误消息
  - 错误恢复建议
  - _需求: 8.3.5_

---

## 📊 工作量估算

### 按优先级
- **优先级1** (核心功能完善): 1-2周
- **优先级2** (测试): 2-3周
- **优先级3** (监控): 1-2周
- **优先级4** (功能增强): 3-4周
- **优先级5** (性能优化): 2-3周
- **优先级6** (文档): 1周

**总计**: 约10-15周 (2.5-4个月)

### 按类别
- **测试**: 30%
- **功能开发**: 40%
- **监控和运维**: 15%
- **文档**: 10%
- **性能优化**: 5%

---

## 🎯 建议的实施顺序

### 第1阶段 (2周) - 稳定性
1. 任务状态同步优化
2. Batch作业完成处理
3. 资源清理
4. 基本监控和告警

### 第2阶段 (3周) - 质量保证
1. 单元测试
2. 集成测试
3. 错误场景测试
4. 性能测试

### 第3阶段 (4周) - 功能完善
1. 多卫星支持完善
2. 时间合成功能
3. Shapefile支持
4. 中国地图服务集成

### 第4阶段 (2周) - 优化和文档
1. 性能优化
2. 文档完善
3. 部署自动化
4. 用户培训

---

**文档版本**: 1.0
**创建日期**: 2026-02-06
**维护者**: 开发团队
