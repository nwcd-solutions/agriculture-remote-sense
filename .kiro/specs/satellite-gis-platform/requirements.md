# 需求文档

## 简介

基于 AWS Open Data 的综合卫星遥感数据处理 Web 应用，设计为 Google Earth Engine 的私有化/企业级替代方案。系统提供多种卫星数据集的统一访问、植被指数计算、时间合成功能和交互式 Web GIS 功能。

## 术语表

- **系统**: 卫星 GIS 平台 Web 应用
- **STAC_API**: 时空资产目录 API，用于统一数据索引
- **AOI**: 用户定义的感兴趣区域，用于数据处理
- **COG**: 云优化 GeoTIFF 格式，用于高效的云端栅格访问
- **植被指数**: 光谱波段的数学组合，用于评估植被健康状况
- **时间合成**: 多个影像在时间维度上的统计聚合
- **数据处理器**: 处理卫星数据操作的后端服务
- **Web界面**: 具有交互式地图功能的前端 React 应用
- **质量掩膜**: 应用于光学卫星数据的云和质量过滤

## 需求

### 需求 1: 多卫星数据源支持

**用户故事:** 作为遥感分析师，我希望能够访问 AWS Open Data 中的多种卫星数据集，以便进行全面的地球观测分析。

#### 验收标准

1. 当访问 Sentinel-1 数据时，系统应支持 GRD 和 RTC 产品，包含 VV 和 VH 极化
2. 当访问 Sentinel-2 数据时，系统应支持 L1C 和 L2A 处理级别
3. 当访问 Landsat 8 数据时，系统应支持 Collection 2 Level-1 和 Level-2 产品
4. 当访问 MODIS 数据时，系统应支持 Terra 和 Aqua 反射率及植被产品
5. STAC_API 应作为所有卫星数据集的统一索引层
6. 数据处理器应使用 pystac-client 进行数据发现和访问

### 需求 2: 交互式感兴趣区域定义

**用户故事:** 作为 GIS 用户，我希望通过多种输入方法定义研究区域，以便灵活指定分析区域。

#### 验收标准

1. 当使用 Web 界面时，Web界面应允许在交互式地图上绘制多边形
2. 当上传 Shapefile 数据时，系统应接受包含必需的 .shx、.dbf 和 .prj 组件的 .shp 文件
3. 当上传 GeoJSON 文件时，系统应解析并验证几何图形
4. 系统应将所有 AOI 输入转换为标准化的 GeoJSON 格式供后端处理
5. Web界面应在地图上显示定义的 AOI，并具有清晰的视觉边界

### 需求 3: 卫星数据查询和过滤

**用户故事:** 作为遥感分析师，我希望基于多种条件搜索和过滤卫星影像，以便找到最适合分析的数据。

#### 验收标准

1. 当查询卫星数据时，系统应支持按卫星类型（Sentinel-1、Sentinel-2、Landsat 8、MODIS）过滤
2. 当选择产品级别时，系统应根据卫星类型提供适当的选项（L1、L2）
3. 当指定时间范围时，系统应接受开始和结束日期参数
4. 当过滤 Sentinel-2 数据时，系统应支持云量百分比过滤
5. 当过滤 Landsat 8 数据时，系统应支持使用 CLOUD_COVER 字段进行基于元数据的云量过滤
6. 当过滤 MODIS 数据时，系统应在适用的情况下利用可用的质量或云掩膜字段
7. 当显示查询结果时，系统应显示影像获取时间、传感器类型和产品级别
8. 系统应仅返回与指定 AOI 相交的影像

### 需求 4: 数据下载和处理

**用户故事:** 作为数据分析师，我希望下载裁剪到感兴趣区域的卫星影像，以便使用可管理的文件大小进行本地分析。

#### 验收标准

1. 当下载单个影像时，系统应将数据裁剪到指定的 AOI 边界
2. 当下载多个影像时，系统应支持批处理和下载
3. 系统应以云优化 GeoTIFF 格式输出所有下载的数据
4. 数据处理器应保留原始空间分辨率和投影信息
5. 系统应为大型数据集提供下载进度指示器

### 需求 5: 植被指数计算

**用户故事:** 作为植被分析师，我希望从卫星影像计算标准植被指数，以便评估植被健康状况和覆盖度。

#### 验收标准

1. 当选择植被指数时，Web界面应提供 NDVI、SAVI、EVI、PVI 和 VGI 选项
2. 当计算 NDVI 时，数据处理器应使用公式 (NIR - Red) / (NIR + Red)
3. 当计算 SAVI 时，数据处理器应使用公式 (1 + L) * (NIR - Red) / (NIR + Red + L)，其中 L = 0.5
4. 当计算 EVI 时，数据处理器应使用公式 2.5 * (NIR - Red) / (NIR + 6*Red - 7.5*Blue + 1)
5. 当计算 PVI 时，数据处理器应使用公式 NIR - a * Red - b，并提供参数来源文档
6. 当计算 VGI 时，数据处理器应使用公式 Green / Red
7. 系统应仅在数据集中有所需光谱波段时启用指数选择
8. 系统应支持在一次操作中进行单个或多个指数计算
9. 系统应以 GeoTIFF COG 格式输出植被指数

### 需求 6: 源代码透明性

**用户故事:** 作为研究人员，我希望查看计算逻辑和源代码，以便理解和验证处理方法。

#### 验收标准

1. 当查看植被指数计算时，Web界面应提供计算公式的访问
2. 当检查处理逻辑时，Web界面应显示相关的后端代码片段
3. 系统应维护所有计算方法的最新文档
4. Web界面应清晰地呈现具有适当符号的数学公式

### 需求 7: 时间合成能力

**用户故事:** 作为时间序列分析师，我希望创建卫星影像的时间合成，以便分析季节模式并减少单个观测的噪声。

#### 验收标准

1. 当创建时间合成时，系统应支持 10 天（旬度）、月度和季度周期
2. 当合成多个影像时，数据处理器应计算时间维度上的均值
3. 当处理光学数据时，数据处理器应在合成前应用云和质量掩膜
4. 当生成合成时，系统应在处理前将所有输入影像裁剪到 AOI
5. 系统应为每个指定时间段输出一个合成结果
6. 系统应支持所有支持的卫星数据集的时间合成
7. Web界面应允许用户通过界面选择合成周期
8. 系统应提供时间合成源代码实现的访问

### 需求 8: 真实地图服务集成

**用户故事:** 作为 GIS 用户，我希望有一个像百度地图、高德地图一样的真实地图界面，显示详细的地理信息，以便更好地进行卫星数据分析。

#### 验收标准

1. 系统应集成真实的地图服务提供商（百度地图、高德地图、OpenStreetMap、天地图）
2. 当显示地图时，系统应显示真实的道路、建筑、地形、水系等地理要素
3. 系统应支持多种地图类型：卫星影像、街道地图、地形图、混合模式
4. 系统应提供地图缩放功能，支持从全球视图到街道级别的详细显示
5. 系统应显示地名标注、道路名称、兴趣点（POI）等地理信息
6. 系统应支持中文地名显示和本地化地图服务
7. 当网络连接时，系统应优先使用在线地图服务
8. 当离线时，系统应提供基础的地图功能作为降级方案

### 需求 8.1: 多地图服务支持

**用户故事:** 作为用户，我希望能够选择不同的地图服务提供商，以便根据需要使用最合适的地图数据。

#### 验收标准

1. 系统应支持百度地图 API 集成，提供中国地区详细地图
2. 系统应支持高德地图 API 集成，提供高精度的中国地图服务
3. 系统应支持天地图 API 集成，提供官方标准地图服务
4. 系统应支持 OpenStreetMap 作为免费的全球地图选项
5. 系统应支持 Mapbox 作为高质量的国际地图服务
6. 用户应能够在不同地图服务间切换
7. 系统应根据用户位置自动选择最适合的地图服务
8. 系统应处理不同地图服务的坐标系差异（WGS84、GCJ02、BD09）

### 需求 8.2: 地图交互功能

**用户故事:** 作为 GIS 分析师，我希望地图具有丰富的交互功能，以便进行专业的地理空间分析。

#### 验收标准

1. 系统应支持地图平移、缩放、旋转等基础交互
2. 系统应支持地图图层管理，可以显示/隐藏不同图层
3. 系统应支持地图测量功能（距离、面积、角度）
4. 系统应支持地图标注和绘制功能
5. 系统应支持地图打印和截图功能
6. 系统应支持地图全屏显示模式
7. 系统应提供地图导航控件和比例尺显示
8. 系统应支持地图定位功能，可以定位到指定坐标

### 需求 8.3: 浏览器兼容性和降级方案

**用户故事:** 作为最终用户，我希望无论使用什么浏览器，都能获得良好的地图体验。

#### 验收标准

1. 当使用现代浏览器时，系统应提供完整的地图功能
2. 当使用较旧浏览器时，系统应自动降级到兼容的地图实现
3. 当网络不可用时，系统应提供离线地图或静态地图作为备选
4. 系统应检测浏览器能力并选择最适合的地图渲染方式
5. 系统应提供地图加载状态指示和错误处理
6. 系统应在移动设备上提供触摸友好的地图交互
7. 系统应支持高分辨率屏幕的地图显示优化

### 需求 9: 系统架构和性能

**用户故事:** 作为系统管理员，我希望有一个可扩展和可维护的系统架构，以便平台能够高效处理多个用户和大型数据集。

#### 验收标准

1. 系统应使用 FastAPI 作为后端 Web 框架
2. 数据处理器应使用 GDAL 进行栅格 I/O、裁剪和重投影操作
3. 数据处理器应使用 rasterio 和 rioxarray 进行基于 Python 的栅格处理
4. 数据处理器应使用 xarray 进行多维数据处理
5. 数据处理器应使用 Dask 进行并行处理和时间合成
6. Web界面应使用 React 框架构建
7. 系统应保持前端展示和后端处理逻辑的分离
8. 系统应使用 AWS Batch 执行计算密集型任务
9. 系统应使用 Amazon S3 存储处理结果
10. 系统应使用 DynamoDB 存储任务状态和元数据

### 需求 10: AWS Batch 集成和任务管理

**用户故事:** 作为系统架构师，我希望使用 AWS Batch 处理大规模计算任务，以便系统能够可靠地处理任意大小的数据集，并优化成本。

#### 验收标准

1. 当提交处理任务时，系统应将任务提交到 AWS Batch 队列
2. 当任务执行时，AWS Batch 应使用 Docker 容器运行处理代码
3. 当任务完成时，系统应将结果保存到 S3 存储桶
4. 系统应使用数据库存储任务状态（queued, running, completed, failed）
5. 系统应提供 API 端点查询任务状态和进度
6. 系统应支持任务失败重试机制（最多 3 次）
7. 系统应记录任务执行日志到 CloudWatch
8. 系统应在任务完成后发送通知（可选：SNS/SQS）
9. 系统应定期清理过期的任务记录和 S3 文件
10. 系统应支持使用 Spot 实例降低计算成本
11. 系统应使用 AWS CDK 定义和部署所有基础设施
12. 基础设施代码应支持多环境部署（dev, staging, prod）